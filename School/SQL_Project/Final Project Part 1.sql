--Intermediate SQL Final Project, Part 1 
--Adam Brewer

-- Question 1

DROP TABLE DETAILRENTAL;
DROP TABLE GAMECOPY;
DROP TABLE GAME;
DROP TABLE PRICE;
DROP TABLE RENTAL;
DROP TABLE MEMBERSHIP;

CREATE TABLE MEMBERSHIP (
	MEM_NUM CHAR(4) NOT NULL,
	FNAME VARCHAR2(40) NOT NULL,
	LNAME VARCHAR2(40) NOT NULL,
	STREET VARCHAR2(120),
	CITY VARCHAR2(50),
	PROV CHAR(2),
	POSTAL CHAR(7),
	BALANCE NUMBER(10,2) CHECK (BALANCE >= 0),
	PRIMARY KEY (MEM_NUM)
);
CREATE TABLE PRICE (
	PRICE_CODE CHAR(2) NOT NULL,
	DESCRIPTION VARCHAR2(20) NOT NULL,
	RENT_FEE NUMBER(5,2) NOT NULL CHECK (RENT_FEE >= 0),
	DAILY_LATE_FEE NUMBER(5,2) NOT NULL CHECK (DAILY_LATE_FEE >= 0),
	PRIMARY KEY (PRICE_CODE)
);
CREATE TABLE RENTAL (
	RENT_NUM CHAR(5) NOT NULL,
	RENT_DATE DATE NOT NULL,
	MEM_NUM CHAR(4) NOT NULL,
	PRIMARY KEY (RENT_NUM)
);
CREATE TABLE GAME (
	GA_NUM CHAR(5) NOT NULL,
	TITLE VARCHAR2(75) NOT NULL,
	YEAR CHAR(4) NOT NULL CHECK (YEAR >= 1970),
	COST NUMBER(5,2),
	GENRE VARCHAR2(50),
	PRICE_CODE CHAR(2) NOT NULL,
	PRIMARY KEY (GA_NUM)
);
CREATE TABLE DETAILRENTAL (
	RENT_NUM CHAR(5) NOT NULL,
	GC_NUM CHAR(6) NOT NULL,
	FEE NUMBER(5,2) NOT NULL,
	DUE_DATE DATE NOT NULL,
	RETURN_DATE DATE,
	DAILY_LATE_FEE NUMBER(5,2) NOT NULL
) ;
CREATE TABLE GAMECOPY (
	GC_NUM CHAR(6) NOT NULL,
	INDATE DATE NOT NULL,
	GA_NUM CHAR(5) NOT NULL,
	PRIMARY KEY (GC_NUM)
);

ALTER TABLE RENTAL
ADD FOREIGN KEY (MEM_NUM) REFERENCES MEMBERSHIP(MEM_NUM);
ALTER TABLE DETAILRENTAL
ADD FOREIGN KEY (RENT_NUM) REFERENCES RENTAL(RENT_NUM);
ALTER TABLE DETAILRENTAL
ADD FOREIGN KEY (GC_NUM) REFERENCES GAMECOPY(GC_NUM);
ALTER TABLE GAMECOPY
ADD FOREIGN KEY (GA_NUM) REFERENCES GAME(GA_NUM);
ALTER TABLE GAME
ADD FOREIGN KEY (PRICE_CODE) REFERENCES PRICE(PRICE_CODE);

--Question 2
INSERT INTO MEMBERSHIP VALUES ('102', 'TAMI', 'DAWSON', '2632 TAKLI CIRCLE', 'FREDERICTON', 'NB', 'E4C 1X2', '11');
INSERT INTO MEMBERSHIP VALUES ('103', 'CURT', 'KNIGHT', '4025 CORNELL COURT', 'HALIFAX', 'NS', 'E2T 1T2', '6');
INSERT INTO MEMBERSHIP VALUES ('104', 'JAMAL', 'MELENDEZ', '788 EAST 145TH AVENUE', 'MONCTON', 'NB', 'E4C 1U2', '0');
INSERT INTO MEMBERSHIP VALUES ('105', 'IVA','MCCLAIN', '6045 MUSKET BALL CIRCLE', 'SUMMIT', 'NS', 'E4T 1J2', '15');
INSERT INTO MEMBERSHIP VALUES ('106', 'MIRANDA', 'PARKS', '4469 MAXWELL PLACE', 'GERMANTOWN', 'NB', 'E2H 1S2', '0');
INSERT INTO MEMBERSHIP VALUES ('107', 'ROSARIO', 'ELLIOT', '7578 DANNER AVENUE', 'TRACEY', 'NB', 'E4C 1G2', '5');
INSERT INTO MEMBERSHIP VALUES ('108', 'MATTIE', 'GUY', '4390 EVERGREEN STREET', 'LILY', 'NS', 'E2K 1F2', '0');
INSERT INTO MEMBERSHIP VALUES ('109', 'CLINT', 'OCHOA', '1711 ELM STREET', 'GREENEVILLE', 'NB', 'E7C 1H2', '10');
INSERT INTO MEMBERSHIP VALUES ('110', 'LEWIS', 'ROSALES', '4524 SOUTHWIND CIRCLE', 'SUSSEX', 'NB', 'E7H 1X8', '0');
INSERT INTO MEMBERSHIP VALUES ('111', 'STACY', 'MANN', '2789 EAST COOK AVENUE', 'DIEPPE', 'NB', 'E4C 1C2', '8');
INSERT INTO MEMBERSHIP VALUES ('112', 'LUIS', 'TRUJILLO', '7267 MELVIN AVENUE', 'ST. ANDREWS', 'NB', 'E4A 1X2', '3');
INSERT INTO MEMBERSHIP VALUES ('113', 'MINNIE', 'GONZALES', '6430 VASILI DRIVE', 'SAINT JOHN', 'NB', 'E3P 1X5', '0');

INSERT INTO PRICE VALUES ('1', 'Standard', '2', '1.5');
INSERT INTO PRICE VALUES ('2', 'New Release', '3.5', '3');
INSERT INTO PRICE VALUES ('3', 'Discount', '1.5', '1');
INSERT INTO PRICE VALUES ('4', 'Weekly Special', '1', '0.5');

INSERT INTO RENTAL VALUES ('1001', '17-03-01', '103');
INSERT INTO RENTAL VALUES ('1002', '16-12-12', '105');
INSERT INTO RENTAL VALUES ('1003', '16-11-13', '102');
INSERT INTO RENTAL VALUES ('1004', '17-03-10', '110');
INSERT INTO RENTAL VALUES ('1005', '17-02-04', '111');
INSERT INTO RENTAL VALUES ('1006', '17-02-25', '107');
INSERT INTO RENTAL VALUES ('1007', '16-12-12', '104');
INSERT INTO RENTAL VALUES ('1008', '17-01-01', '105');
INSERT INTO RENTAL VALUES ('1009', '16-10-12', '111');

INSERT INTO GAME VALUES ('1234', 'BATTLEFIELD 1', '2016', '79.99', 'ACTION', '1');
INSERT INTO GAME VALUES ('1235', 'MASS Effect Andromeda', '2017', '89.99', 'ACTION', '2');
INSERT INTO GAME VALUES ('1236', 'Everquest', '1999', '59.95', 'RPG', '3');
INSERT INTO GAME VALUES ('1237', 'Fable II', '2010', '49.95', 'RPG', '3');
INSERT INTO GAME VALUES ('1238', 'Mario Kart 8 Deluxe', '2017', '89.95', 'RACING', '2');
INSERT INTO GAME VALUES ('1239', 'Blur', '2010', '29.49', 'RACING', '1');
INSERT INTO GAME VALUES ('1245', 'Grand Theft Auto V', '2012', '45.49', 'ACTION', '1');
INSERT INTO GAME VALUES ('1246', 'Halo 4', '2012', '58.29', 'ACTION', '1');
INSERT INTO GAME VALUES ('1247', 'Wipeout 3', '2012', '58.29', 'SIMULATION', '1');

INSERT INTO GAMECOPY VALUES ('34341', '17-01-22', '1235');
INSERT INTO GAMECOPY VALUES ('34342', '17-01-22', '1235');
INSERT INTO GAMECOPY VALUES ('34366', '99-03-02', '1236');
INSERT INTO GAMECOPY VALUES ('34367', '99-03-02', '1236');
INSERT INTO GAMECOPY VALUES ('34368', '99-03-02', '1236');
INSERT INTO GAMECOPY VALUES ('34369', '99-03-02', '1236');
INSERT INTO GAMECOPY VALUES ('44392', '10-10-21', '1237');
INSERT INTO GAMECOPY VALUES ('44397', '10-10-21', '1237');
INSERT INTO GAMECOPY VALUES ('54321', '16-06-18', '1234');
INSERT INTO GAMECOPY VALUES ('54324', '16-06-18', '1234');
INSERT INTO GAMECOPY VALUES ('54325', '16-06-18', '1234');
INSERT INTO GAMECOPY VALUES ('59237', '10-02-14', '1237');
INSERT INTO GAMECOPY VALUES ('61353', '13-01-28', '1245');
INSERT INTO GAMECOPY VALUES ('61354', '13-01-28', '1245');
INSERT INTO GAMECOPY VALUES ('61367', '12-07-30', '1246');
INSERT INTO GAMECOPY VALUES ('61369', '12-07-30', '1246');
INSERT INTO GAMECOPY VALUES ('61388', '10-01-25', '1239');

INSERT INTO DETAILRENTAL VALUES ('1001', '34342', '3.5', '17-03-04', '17-03-02', '3');
INSERT INTO DETAILRENTAL VALUES ('1001', '34366', '1.5', '17-03-04', '17-03-02', '1');
INSERT INTO DETAILRENTAL VALUES ('1001', '61353', '2', '17-03-04', '17-03-02', '1.5');
INSERT INTO DETAILRENTAL VALUES ('1002', '59237', '1.5', '16-12-15', '16-12-15', '1');
INSERT INTO DETAILRENTAL VALUES ('1003', '54325', '2', '16-11-16', '16-11-21', '1.5');
INSERT INTO DETAILRENTAL VALUES ('1003', '61369', '2', '16-11-16', '16-11-18', '1.5');
INSERT INTO DETAILRENTAL VALUES ('1003', '61388', '2', '16-11-16', '16-11-18', '1.5');
INSERT INTO DETAILRENTAL VALUES ('1004', '34341', '3.5', '17-03-13', '17-03-13', '3');
INSERT INTO DETAILRENTAL VALUES ('1004', '34367', '1.5', '17-03-13', '17-03-14', '1');
INSERT INTO DETAILRENTAL VALUES ('1004', '44392', '1.5', '17-03-13', '17-03-12', '1');
INSERT INTO DETAILRENTAL VALUES ('1005', '34342', '3.5', '17-02-07', '17-02-07', '3');
INSERT INTO DETAILRENTAL VALUES ('1005', '44397', '1.5', '17-02-07', '17-02-06', '1');
INSERT INTO DETAILRENTAL VALUES ('1006', '34366', '1.5', '17-02-28', '17-02-28', '1');
INSERT INTO DETAILRENTAL VALUES ('1006', '61367', '2', '17-02-28', NULL, '1.5');
INSERT INTO DETAILRENTAL VALUES ('1007', '34368', '1.5', '16-12-15', NULL, '1');
INSERT INTO DETAILRENTAL VALUES ('1008', '34369', '1.5', '17-01-04', '17-01-04', '1');
INSERT INTO DETAILRENTAL VALUES ('1009', '54324', '2', '16-10-15', NULL, '1.5');


--Question 3
COMMIT;

--Question 4
UPDATE GAME
SET YEAR = '2010'
WHERE GA_NUM = '1245';

--Question 5
UPDATE GAME
SET PRICE_CODE = '4'
WHERE GENRE = 'SIMULATION';

--Question 6
UPDATE PRICE
SET RENT_FEE = (RENT_FEE + 0.5);

--Question 7
COMMIT;

--Question 8
SELECT GENRE, TITLE, YEAR, COST FROM GAME
ORDER BY GENRE, YEAR DESC;

--Question 9
SELECT MEM_NUM, (LNAME || ', ' || FNAME ) AS MEMBER_NAME, BALANCE FROM MEMBERSHIP;

--Question 10
ALTER TABLE MEMBERSHIP
ADD STATUS CHAR(8) CHECK (STATUS IN ('ACTIVE','SUSPENDED','CLOSED'));
SELECT MEM_NUM, (LNAME || ', ' || FNAME ) AS MEMBER_NAME, BALANCE, STATUS FROM MEMBERSHIP;

--Question 11
UPDATE MEMBERSHIP
SET STATUS = 'ACTIVE'
WHERE MEMBERSHIP.MEM_NUM = RENTAL.MEM_NUM;
SELECT MEM_NUM, (LNAME || ', ' || FNAME ) AS MEMBER_NAME, BALANCE, STATUS FROM MEMBERSHIP;

--Question 12
SELECT GENRE, TITLE, YEAR, COST FROM GAME
WHERE TITLE LIKE '%EF%' OR TITLE LIKE '%ef%' OR TITLE LIKE '%Ef%'
ORDER BY GENRE, YEAR DESC;

--Question 13
SELECT GENRE, TITLE, YEAR, COST FROM GAME
WHERE (GENRE = 'RACING' OR GENRE = 'RPG') AND COST < 60
ORDER BY GENRE, TITLE;

--Question 14
SELECT GENRE, COUNT(GENRE)AS IN_STOCK FROM GAME
GROUP BY GENRE ORDER BY COUNT(GENRE) DESC;

--Question 15
SELECT AVG(COST) AS AVERAGE_COST FROM GAME;

--Question 16
SELECT GENRE, AVG(COST) AS AVG_GAME_COST FROM GAME
GROUP BY GENRE ORDER BY GENRE;

--Question 17
SELECT G.TITLE AS GAME_TITLE, G.GENRE, P.DESCRIPTION AS PRICING_DESCRIPTION, P.RENT_FEE AS RENTAL_FEE, G.COST AS GAME_COST
FROM GAME G INNER JOIN PRICE P
ON P.PRICE_CODE = G.PRICE_CODE;

--Question 18
SELECT G.GENRE, AVG(P.RENT_FEE) AS AVG_FEE 
FROM GAME G INNER JOIN PRICE P ON P.PRICE_CODE = G.PRICE_CODE
GROUP BY G.GENRE ORDER BY G.GENRE;

--Question 19
SELECT G.GENRE, G.TITLE, G.COST FROM GAME G 
WHERE G.COST > (SELECT AVG(GA.COST) FROM GAME GA WHERE GA.GENRE = G.GENRE);

--Question 20
UPDATE GAME G
SET G.COST = (G.COST -2.50)
WHERE G.COST > (SELECT AVG(GA.COST) FROM GAME GA WHERE GA.GENRE = G.GENRE)
COMMIT;

--Question 21
SELECT G.TITLE, G.YEAR, ROUND((G.COST/P.RENT_FEE),2) AS BER
FROM GAME G INNER JOIN PRICE P ON P.PRICE_CODE = G.PRICE_CODE;
 
--Question 22
SELECT M.MEM_NUM, (M.LNAME || ', ' || M.FNAME ) AS MEMBER_NAME, M.BALANCE FROM MEMBERSHIP M
INNER JOIN RENTAL R ON M.MEM_NUM = R.MEM_NUM
WHERE M.MEM_NUM = R.MEM_NUM;

--Question 23
SELECT R.RENT_NUM, R.RENT_DATE, G.TITLE, D.FEE FROM RENTAL R
INNER JOIN DETAILRENTAL D ON R.RENT_NUM = D.RENT_NUM
INNER JOIN GAMECOPY GC ON GC.GC_NUM = D.GC_NUM
INNER JOIN GAME G ON G.GA_NUM = GC.GA_NUM
WHERE D.RETURN_DATE <= D.DUE_DATE;

--Question 24
SELECT R.RENT_NUM, GC.GC_NUM, G.TITLE, R.RENT_DATE, D.DUE_DATE, D.RETURN_DATE FROM RENTAL R
INNER JOIN DETAILRENTAL D ON R.RENT_NUM = D.RENT_NUM
INNER JOIN GAMECOPY GC ON GC.GC_NUM = D.GC_NUM
INNER JOIN GAME G ON G.GA_NUM = GC.GA_NUM
WHERE D.RETURN_DATE > D.DUE_DATE
ORDER BY R.RENT_NUM, G.TITLE;

--Question 25
SELECT R.RENT_NUM, GC.GC_NUM, G.TITLE, R.RENT_DATE, D.DUE_DATE, D.RETURN_DATE, (D.RETURN_DATE - D.DUE_DATE) AS DAYS_LATE FROM RENTAL R
INNER JOIN DETAILRENTAL D ON R.RENT_NUM = D.RENT_NUM
INNER JOIN GAMECOPY GC ON GC.GC_NUM = D.GC_NUM
INNER JOIN GAME G ON G.GA_NUM = GC.GA_NUM
WHERE D.RETURN_DATE > D.DUE_DATE
ORDER BY R.RENT_NUM, G.TITLE;

--Question 26
SELECT R.RENT_NUM, GC.GC_NUM, G.TITLE, R.RENT_DATE, D.DUE_DATE, D.RETURN_DATE, (D.RETURN_DATE - D.DUE_DATE) AS DAYS_LATE,
(D.DAILY_LATE_FEE * (D.RETURN_DATE - D.DUE_DATE)) AS LATE_FEES_PAID FROM RENTAL R
INNER JOIN DETAILRENTAL D ON R.RENT_NUM = D.RENT_NUM
INNER JOIN GAMECOPY GC ON GC.GC_NUM = D.GC_NUM
INNER JOIN GAME G ON G.GA_NUM = GC.GA_NUM
WHERE D.RETURN_DATE > D.DUE_DATE
ORDER BY R.RENT_NUM, G.TITLE;

--Question 27
SELECT R.RENT_NUM, GC.GC_NUM, G.TITLE, R.RENT_DATE AS RENTED_ON, D.DUE_DATE AS DUE_BACK_BY, ROUND((SYSDATE - D.DUE_DATE),2) AS DAYS_LATE,
ROUND((D.DAILY_LATE_FEE * (SYSDATE - D.DUE_DATE)),2) AS LATE_FEES_OWING FROM RENTAL R
INNER JOIN DETAILRENTAL D ON R.RENT_NUM = D.RENT_NUM
INNER JOIN GAMECOPY GC ON GC.GC_NUM = D.GC_NUM
INNER JOIN GAME G ON G.GA_NUM = GC.GA_NUM
WHERE D.RETURN_DATE > D.DUE_DATE
ORDER BY R.RENT_NUM, G.TITLE;

--Question 28 ???
SELECT M.MEM_NUM, (LNAME || ', ' || FNAME ) AS MEMBER_NAME, COUNT(R.MEM_NUM) AS NUMBER_GAMES, SUM(D.FEE) AS RENTAL_FEE,
(D.DAILY_LATE_FEE * (D.RETURN_DATE - D.DUE_DATE)) AS LATE_FEE, SUM((D.FEE) + (D.DAILY_LATE_FEE * (D.RETURN_DATE - D.DUE_DATE))) AS TOTAL_FEES
FROM MEMBERSHIP M INNER JOIN RENTAL R ON M.MEM_NUM = R.MEM_NUM
INNER JOIN DETAILRENTAL D ON R.RENT_NUM = D.RENT_NUM
WHERE D.RETURN_DATE > D.DUE_DATE
GROUP BY R.MEM_NUM, M.MEM_NUM, (LNAME || ', ' || FNAME ), (D.DAILY_LATE_FEE * (D.RETURN_DATE - D.DUE_DATE));




















